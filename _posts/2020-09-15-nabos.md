---
layout: single
title:  "Os nabos"
permalink: /nabos/


sidebar:
 - title: "Laboratórios Linux"
   text: "Espreitar o systemd."
 - title: "linuxlabs"
   nav: sidebar-linuxlabs

excerpt: "Nabos. laboratório 010"
#date:   2020-09-16 17:40:00 +0100
categories: linuxlabs containers nabos
toc: true
toc_label: "nabos"
toc_sticky: true
#classes: wide
header:
  teaser: /labs/009-arch-nabo/term-teaser.png
  image:  /labs/009-arch-nabo/term2.png

author_profile: true
read_time: true
comments: true
share: true
related: true

---


# contentores com systemd-nspawn 
- Uma primeira suave abordagem aos containers.

## Os Nabos

systemd-nspawn com -bD, sem userspace.

com user vint e id=1000.



### Estrutura

- Criar piscina para os nabos.

Criar subvolume *`NABOS`* em *`/srv/maquinas`*


```
[vint@generd /srv/maquinas ] $ btrfs subvolume create NABOS
Create subvolume './NABOS'
[vint@generd /srv/maquinas ] $
```



### naboctl


o actuat **naboctl.sh** está em **`/opt/bash/naboctl.sh`**

[naboctl.sh](/labs/010-nabo/naboctl.sh.txt)

```
[vint@generd /srv/maquinas ] $ whereis naboctl 
naboctl: /usr/local/bin/naboctl
[vint@generd /srv/maquinas ] $ 
[vint@generd /srv/maquinas ] $ cat /usr/local/bin/naboctl 
#!/bin/bash
#2020-08-27
#V1.0

time bash /opt/bash/naboctl.sh $@

[vint@generd /srv/maquinas ] $ 
```

### rede

Havendo novos interfaces criados, como o ***tun*** no caso das vpn's, vou utilzar a rede macvlan em `enp7s0`.

Com IP estático pré-definido, uma vez q não quero o dhcp do router nos misturado.

A rede local é claro 192.1.68.1.0/24, e vou usar para os nabos IP's superiores a 192.168.1.220.




## nabo-tor

- Criar `nabo-tor` em NABOS como snapshot do `arch-nabo`

```
[vint@generd /srv/maquinas ] $ btrfs subvolume snapshot arch-nabo/ NABOS/nabo-tor
Create a snapshot of 'arch-nabo/' in 'NABOS/nabo-tor'
[vint@generd /srv/maquinas ] $
```


### **`/var/lib/tor`**


```
[vint@nabo /var/lib ] $ sudo  mkdir tor
[vint@nabo /var/lib ] $ 
[vint@nabo /var/lib ] $ sudo chown tor tor -R
[vint@nabo /var/lib ] $ sudo systemctl start tor
[vint@nabo /var/lib ] $ systemctl status tor
* tor.service - Anonymizing Overlay Network
     Loaded: loaded (/usr/lib/systemd/system/tor.service; disabled; vendor preset: disabled)
     Active: active (running) since Sun 2020-09-20 23:20:24 WEST; 3s ago
   Main PID: 278 (tor)
     CGroup: /system.slice/tor.service
             `-278 /usr/bin/tor -f /etc/tor/torrc

Sep 20 23:20:24 nabo Tor[278]: Fixing permissions on directory /var/lib/tor
Sep 20 23:20:24 nabo Tor[278]: Parsing GEOIP IPv4 file /usr/share/tor/geoip.
Sep 20 23:20:24 nabo Tor[278]: Parsing GEOIP IPv6 file /usr/share/tor/geoip6.
Sep 20 23:20:24 nabo Tor[278]: Bootstrapped 0% (starting): Starting
Sep 20 23:20:24 nabo Tor[278]: Starting with guard context "default"
Sep 20 23:20:25 nabo Tor[278]: Bootstrapped 5% (conn): Connecting to a relay
Sep 20 23:20:25 nabo Tor[278]: Bootstrapped 10% (conn_done): Connected to a relay
Sep 20 23:20:27 nabo Tor[278]: Bootstrapped 14% (handshake): Handshaking with a relay
Sep 20 23:20:27 nabo Tor[278]: Bootstrapped 15% (handshake_done): Handshake with a relay done
Sep 20 23:20:27 nabo Tor[278]: Bootstrapped 20% (onehop_create): Establishing an encrypted directory connection
[vint@nabo /var/lib ] $ 
[vint@nabo /var/lib ] $ ls -la
total 4

```


### blackarch em tor


```
[vint@nabo /var/lib ] $ 
[vint@nabo /var/lib ] $ 
[vint@nabo /var/lib ] $ 
[vint@nabo /var/lib ] $ time sudo bash ~/FILES/VITAMINAS/strap.sh 
[+] installing blackarch keyring...
gpg: Warning: using insecure memory!
loading packages...
resolving dependencies...
looking for conflicting packages...

Packages (1) blackarch-keyring-20140118-3

Total Installed Size:  0.04 MiB

:: Proceed with installation? [Y/n] 
(1/1) checking keys in keyring                                                                   [########################################################] 100%
(1/1) checking package integrity                                                                 [########################################################] 100%
(1/1) loading package files                                                                      [########################################################] 100%
(1/1) checking for file conflicts                                                                [########################################################] 100%
:: Processing package changes...
(1/1) installing blackarch-keyring                                                               [########################################################] 100%
==> Appending keys from blackarch.gpg...
gpg: Warning: using insecure memory!
==> Locally signing trusted keys in keyring...
  -> Locally signing key A0917C4147A37007CB54C1CFD295AA940EFDDF62...
  -> Locally signing key 4345771566D76038C7FEB43863EC0ADBEA87E4E3...
  -> Locally signing key CBA3C7D4798912702DCF568E67D8BDF42AD93F4E...
  -> Locally signing key 8F9A9793CB8591147C2EC70566E0CDBD1E01F333...
==> Importing owner trust values...
gpg: Warning: using insecure memory!
==> Updating trust database...
gpg: Warning: using insecure memory!
gpg: next trustdb check due at 2021-01-01
:: Running post-transaction hooks...
(1/1) Arming ConditionNeedsUpdate...
==> Appending keys from archlinux.gpg...
gpg: Warning: using insecure memory!
==> Appending keys from blackarch.gpg...
gpg: Warning: using insecure memory!
==> Locally signing trusted keys in keyring...
  -> Locally signing key D8AFDDA07A5B6EDFA7D8CCDAD6D055F927843F1C...
  -> Locally signing key A0917C4147A37007CB54C1CFD295AA940EFDDF62...
  -> Locally signing key DDB867B92AA789C165EEFA799B729B06A680C281...
  -> Locally signing key 4345771566D76038C7FEB43863EC0ADBEA87E4E3...
  -> Locally signing key CBA3C7D4798912702DCF568E67D8BDF42AD93F4E...
  -> Locally signing key 8F9A9793CB8591147C2EC70566E0CDBD1E01F333...
  -> Locally signing key 91FFE0700E80619CEB73235CA88E23E377514E00...
  -> Locally signing key 0E8B644079F599DFC1DDC3973348882F6AC6A4C2...
  -> Locally signing key AB19265E5D7D20687D303246BA1DFB64FFF979E7...
==> Importing owner trust values...
gpg: Warning: using insecure memory!
gpg: Warning: using insecure memory!
==> Disabling revoked keys in keyring...
  -> Disabling key 8F76BEEA0289F9E1D3E229C05F946DED983D4366...
  -> Disabling key 63F395DE2D6398BBE458F281F2DBB4931985A992...
  -> Disabling key 50F33E2E5B0C3D900424ABE89BDCF497A4BBCC7F...
  -> Disabling key 27FFC4769E19F096D41D9265A04F9397CDFD6BB0...
  -> Disabling key 39F880E50E49A4D11341E8F939E4F17F295AFBF4...
  -> Disabling key 8840BD07FC24CB7CE394A07CCF7037A4F27FB7DA...
  -> Disabling key 5559BC1A32B8F76B3FCCD9555FA5E5544F010D48...
  -> Disabling key 0B20CA1931F5DA3A70D0F8D2EA6836E1AB441196...
  -> Disabling key 07DFD3A0BC213FA12EDC217559B3122E2FA915EC...
  -> Disabling key 4FCF887689C41B09506BE8D5F3E1D5C5D30DB0AD...
  -> Disabling key 5A2257D19FF7E1E0E415968CE62F853100F0D0F0...
  -> Disabling key D921CABED130A5690EF1896E81AF739EC0711BF1...
  -> Disabling key 7FA647CD89891DEDC060287BB9113D1ED21E1A55...
  -> Disabling key BC1FBE4D2826A0B51E47ED62E2539214C6C11350...
  -> Disabling key 4A8B17E20B88ACA61860009B5CED81B7C2E5C0D2...
  -> Disabling key 5696C003B0854206450C8E5BE613C09CB4440678...
  -> Disabling key 684148BB25B49E986A4944C55184252D824B18E8...
  -> Disabling key 8CF934E339CAD8ABF342E822E711306E3C4F88BC...
  -> Disabling key F5A361A3A13554B85E57DDDAAF7EF7873CFD4BB6...
  -> Disabling key 5E7585ADFF106BFFBBA319DC654B877A0864983E...
  -> Disabling key 65EEFE022108E2B708CBFCF7F9E712E59AF5F22A...
  -> Disabling key 40440DC037C05620984379A6761FAD69BA06C6A9...
  -> Disabling key 34C5D94FE7E7913E86DC427E7FB1A3800C84C0A5...
  -> Disabling key 81D7F8241DB38BC759C80FCE3A726C6170E80477...
  -> Disabling key E7210A59715F6940CF9A4E36A001876699AD6E84...
  -> Disabling key 5357F3B111688D88C1D88119FCF2CB179205AC90...
  -> Disabling key 4D913AECD81726D9A6C74F0ADA6426DD215B37AD...
  -> Disabling key FB871F0131FEA4FB5A9192B4C8880A6406361833...
  -> Disabling key 66BD74A036D522F51DD70A3C7F2A16726521E06D...
  -> Disabling key B1F2C889CB2CCB2ADA36D963097D629E437520BD...
  -> Disabling key 9515D8A8EAB88E49BB65EDBCE6B456CAF15447D5...
  -> Disabling key 76B4192E902C0A52642C63C273B8ED52F1D357C1...
  -> Disabling key 40776A5221EF5AD468A4906D42A1DB15EC133BAD...
  -> Disabling key D4DE5ABDE2A7287644EAC7E36D1A9E70E19DAA50...
  -> Disabling key 44D4A033AC140143927397D47EFD567D4C7EA887...
==> Updating trust database...
gpg: Warning: using insecure memory!
gpg: next trustdb check due at 2021-01-01

[+] keyring installed successfully
[+] configuring pacman
[+] fetching new mirror list...
[+] you can change the default mirror under /etc/pacman.d/blackarch-mirrorlist
[+] updating pacman.conf
[+] updating package databases
:: Synchronizing package databases...
 core                                                                130.7 KiB  2.72 MiB/s 00:00 [########################################################] 100%
 extra                                                              1656.8 KiB  5.99 MiB/s 00:00 [########################################################] 100%
 community                                                             5.2 MiB  9.47 MiB/s 00:01 [########################################################] 100%
 blackarch                                                             3.3 MiB  7.40 MiB/s 00:00 [########################################################] 100%
 blackarch.sig                                                       566.0   B  0.00   B/s 00:00 [########################################################] 100%
[+] BlackArch Linux is ready!

real	1m36.642s
user	0m3.152s
sys	0m0.553s
[vint@nabo /var/lib ] $ 
```



## nabo-tor-browser

- Criar `nabo-tor-browser` em NABOS como snapshot do `arch-nabo`


```
[vint@generd /srv/maquinas ] $ btrfs subvolume snapshot arch-nabo/ NABOS/nabo-torbrowser
Create a snapshot of 'arch-nabo/' in 'NABOS/nabo-torbrowser'
[vint@generd /srv/maquinas ] $ 
```

- Instalar **tor-browser** do AUR com pacman -U.


```
[vint@nabo ~ ] $ sudo pacman -U ~/FILES/tor-browser/tor-browser-9.5.4-1-x86_64.pkg.tar.zst 
```

funciona!


## nabo-proton

- Criar `nabo-proton` em NABOS como snapshot do `arch-nabo`


```
[vint@generd ~ ] $ btrfs subvolume snapshot /srv/maquinas/arch-nabo/ /srv/maquinas/NABOS/nabo-proton
Create a snapshot of '/srv/maquinas/arch-nabo/' in '/srv/maquinas/NABOS/nabo-proton'
[vint@generd ~ ] $ 

```

- Instalar *`openvpn`* *`wget`* e *`dialog`*


```
[vint@nabo ~ ] $ sudo pacman -S dialog openvpn wget
```

- Executar script protonvpn


**Nota** Estou a usar a versão antiga com bashscript e não o actual phyton script.
{: .notice--danger}


```
[vint@nabo ~ ] $ 
[vint@nabo ~ ] $ sudo bash FILES/protonvpn-cli.sh 

```

```
[vint@nabo ~ ] $ 
[vint@nabo ~ ] $ sudo bash FILES/protonvpn-cli.sh 
[!] Deprecation warning [!]

This Version of ProtonVPN-CLI has been deprecated and is no longer maintained by the ProtonVPN Team.
It is superseded by Version 2. Due to the new version being written in Python, you can't
update it with the --update option. The new version needs to be installed manually.
For installation instructions, please visit the project page at
https://github.com/ProtonVPN/protonvpn-cli-ng
[!] Error: update-resolv-conf is not installed.
Would you like protonvpn-cli to install update-resolv-conf? (y/N): y
[*] Installing update-resolv-conf...
--2020-09-21 16:30:36--  https://raw.githubusercontent.com/ProtonVPN/scripts/master/update-resolv-conf.sh
Loaded CA certificate '/etc/ssl/certs/ca-certificates.crt'
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 151.101.36.133
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|151.101.36.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 2152 (2.1K) [text/plain]
Saving to: '/etc/openvpn/update-resolv-conf'

/etc/openvpn/update-resolv-con 100%[===================================================>]   2.10K  --.-KB/s    in 0s      

2020-09-21 16:30:38 (11.4 MB/s) - '/etc/openvpn/update-resolv-conf' saved [2152/2152]

[*] Done.

ProtonVPN Command-Line Tool – v1.1.2

Usage: protonvpn-cli.sh [option]

Options:
   --init                              Initialize ProtonVPN profile on the machine.
   -c, --connect                       Select and connect to a ProtonVPN server.
   -c [server-name] [protocol]         Connect to a ProtonVPN server by name.
   -m, --menu                          Select and connect to a ProtonVPN server from a menu.
   -r, --random-connect                Connect to a random ProtonVPN server.
   -l, --last-connect                  Connect to the previously used ProtonVPN server.
   -f, --fastest-connect               Connect to the fastest available ProtonVPN server.
   -p2p, --p2p-connect                 Connect to the fastest available P2P ProtonVPN server.
   -tor, --tor-connect                 Connect to the fastest available ProtonVPN TOR server.
   -sc, --secure-core-connect          Connect to the fastest available ProtonVPN SecureCore server.
   -cc, --country-connect              Select and connect to a ProtonVPN server by country.
   -cc [country-name] [protocol]       Connect to the fastest available server in a specific country.
   -d, --disconnect                    Disconnect the current session.
   --reconnect                         Reconnect to the current ProtonVPN server.
   --ip                                Print the current public IP address.
   --status                            Print connection status.
   --update                            Update protonvpn-cli.
   --install                           Install protonvpn-cli.
   --uninstall                         Uninstall protonvpn-cli.
   -v, --version                       Display version.
   -h, --help                          Show this help message.

[vint@nabo ~ ] $ 
```


```
[vint@nabo ~ ] $ sudo bash FILES/protonvpn-cli.sh --install
[!] Deprecation warning [!]

This Version of ProtonVPN-CLI has been deprecated and is no longer maintained by the ProtonVPN Team.
It is superseded by Version 2. Due to the new version being written in Python, you can't
update it with the --update option. The new version needs to be installed manually.
For installation instructions, please visit the project page at
https://github.com/ProtonVPN/protonvpn-cli-ng
[*] Done.
[vint@nabo ~ ] $ 

```


- Configurar login/password

```
[vint@nabo ~ ] $ sudo protonvpn-cli --init
[!] Deprecation warning [!]

This Version of ProtonVPN-CLI has been deprecated and is no longer maintained by the ProtonVPN Team.
It is superseded by Version 2. Due to the new version being written in Python, you can't
update it with the --update option. The new version needs to be installed manually.
For installation instructions, please visit the project page at
https://github.com/ProtonVPN/protonvpn-cli-ng
Enter OpenVPN username: login
Enter OpenVPN password: password[.] ProtonVPN Plans:
1) Free
2) Basic
3) Plus
4) Visionary
Enter Your ProtonVPN plan ID: 1
[.] Would you like to use a custom DNS server? (Warning: This would make your VPN connection vulnerable to DNS leaks. Only use it when you know what you're doing) [y/N]: y
Custom DNS Server: 192.168.1.130
[.] [Security] Decrease OpenVPN privileges? [Y/n]: 
[*] Done.
[vint@nabo ~ ] $ 
```



```bash
.
.
.
Connecting...
[$] Connected!
[#] New IP: 109.201.133.30
[Warning] You have chosen to use a custom DNS server. This may make you vulnerable to DNS leaks. Re-initialize your profile to disable the use of custom DNS.
[vint@nabo ~ ] $ 
```

```console
.
.
Connecting...
[$] Connected!
[#] New IP: 109.201.133.30
[Warning] You have chosen to use a custom DNS server. This may make you vulnerable to DNS leaks. Re-initialize your profile to disable the use of custom DNS.
[vint@nabo ~ ] $ 
```


funciona !.